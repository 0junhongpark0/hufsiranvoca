<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ì™¸ëŒ€ í˜ë¥´ì‹œì•„ì–´ ë‹¨ì–´ì¥</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #005BAA;
            --accent-color: #FF8c00;
            --bg-color: #f0f2f5;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            user-select: none;
        }

        /* í—¤ë” */
        header {
            background: var(--primary-color);
            color: white; padding: 15px; text-align: center;
            font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative; z-index: 10;
        }
        .header-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            cursor: pointer; font-size: 1.2rem; color: white;
            background: none; border: none; padding: 10px;
        }
        .left-btn { left: 10px; display: none; }
        .right-btn { right: 10px; }

        /* í™”ë©´ ê³µí†µ */
        .screen {
            flex: 1; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; overflow-y: auto;
        }
        .screen.active { display: flex; }

        /* ë©”ë‰´ ë²„íŠ¼ */
        .menu-btn {
            width: 100%; max-width: 320px; padding: 20px; margin: 8px 0;
            border: none; border-radius: 15px;
            background: white; color: #333;
            font-size: 1.1rem; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: space-between;
        }
        .menu-btn:active { transform: scale(0.98); background: #f8f9fa; }
        .menu-btn i { font-size: 1.5rem; color: var(--primary-color); }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .input-group { width: 100%; max-width: 320px; margin-bottom: 15px; }
        .input-label { display: block; font-size: 0.9rem; color: #666; margin-bottom: 5px; font-weight: bold; }
        .input-field, select.input-field { 
            width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 12px; 
            font-size: 1rem; box-sizing: border-box; background: white;
        }
        .input-field:focus { outline: none; border-color: var(--primary-color); }
        
        /* íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ */
        .file-upload-wrapper {
            width: 100%; max-width: 320px; border: 2px dashed #005BAA; border-radius: 15px;
            padding: 30px; text-align: center; background: #f0f7ff; cursor: pointer; margin-bottom: 20px;
        }
        .file-upload-wrapper:active { background: #e0efff; }

        /* íƒ­ ë²„íŠ¼ */
        .tab-box { display: flex; gap: 10px; margin-bottom: 20px; width: 100%; max-width: 320px; }
        .tab-btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 10px; cursor: pointer; color: #888; }
        .tab-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); font-weight: bold; }

        /* ë²„íŠ¼ ê³µí†µ */
        .action-btn {
            width: 100%; padding: 15px; border: none; border-radius: 12px;
            font-weight: bold; font-size: 1rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 5px;
        }
        .btn-blue { background: var(--primary-color); color: white; }
        .btn-orange { background: var(--accent-color); color: white; }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card-container {
            width: 100%; max-width: 350px; height: 380px;
            position: relative; perspective: 1000px; cursor: pointer;
            margin-bottom: 20px;
        }
        .card-inner {
            width: 100%; height: 100%; position: absolute;
            transform-style: preserve-3d; transition: transform 0.6s;
            border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .card-container.flipped .card-inner { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: white; text-align: center; padding: 20px; box-sizing: border-box;
        }
        .card-front { color: var(--primary-color); }
        .card-back { background: var(--primary-color); color: white; transform: rotateY(180deg); }
        
        .persian-text { font-size: 3.5rem; font-weight: bold; margin-bottom: 15px; line-height: 1.2;}
        .pronun-text { font-size: 1.3rem; color: #ffdf7e; font-style: italic; margin-bottom: 10px; font-weight: 500;}
        .korean-text { font-size: 1.8rem; font-weight: bold; word-break: keep-all; line-height: 1.4;}
        
        .control-box { display: flex; gap: 10px; width: 100%; max-width: 350px; }
        .btn-check { flex:1; background: white; color: #999; border: 2px solid #eee; padding: 15px; border-radius: 12px; font-weight: bold;}
        .btn-check.checked { background: var(--success-color); color: white; border-color: var(--success-color); }
        .btn-next { flex:1; background: var(--accent-color); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* ê²Œì„ ìŠ¤íƒ€ì¼ */
        .game-progress { width: 100%; max-width: 350px; margin-bottom: 20px; display: flex; justify-content: space-between; font-weight: bold; color: #666; }
        .quiz-word { font-size: 3.5rem; color: var(--primary-color); font-weight: bold; margin: 20px 0; }
        .options-grid { width: 100%; max-width: 350px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .option-btn {
            padding: 20px 10px; background: white; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: bold; color: #444;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer;
            min-height: 80px; display: flex; align-items: center; justify-content: center;
            word-break: keep-all; transition: 0.1s;
        }
        .option-btn:active { transform: scale(0.95); }
        .option-btn.correct { background: var(--success-color) !important; color: white !important; animation: pop 0.3s; }
        .option-btn.wrong { background: var(--error-color) !important; color: white !important; animation: shake 0.3s; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }

        .chapter-badge { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.1); padding: 5px 10px; border-radius: 10px; font-size: 0.8rem; color: #666; }

        /* ëª¨ë‹¬ (íŒì—…) */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box { background: white; padding: 25px; border-radius: 15px; text-align: center; width: 85%; max-width: 320px; }
    </style>
</head>
<body>

    <header>
        <button class="header-btn left-btn home-btn" onclick="goHome()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <span id="header-title">HUFS Persian</span>
        <button class="header-btn right-btn" onclick="toggleSetting()">
            <i class="fas fa-cog"></i>
        </button>
    </header>

    <div id="screen-home" class="screen active">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="color: #333; margin:0;">ì˜¤ëŠ˜ì˜ í•™ìŠµ</h2>
            <p id="progress-info" style="font-size:0.9rem; color:var(--primary-color); font-weight:bold; margin-top:5px;"></p>
        </div>

        <button class="menu-btn" onclick="setModeAndGo('study', 'all')">
            <div>
                <span>ğŸ² ì „ì²´ ëœë¤ í•™ìŠµ</span>
                <small>ê¸°ë³¸ ë‹¨ì–´ + ë‚´ ë‹¨ì–´ì¥</small>
            </div>
            <i class="fas fa-random"></i>
        </button>

        <button class="menu-btn" onclick="showChapterSelect('study')">
             <div>
                <span>ğŸ“š ì±•í„°ë³„ í•™ìŠµ</span>
                <small>ë²”ìœ„ ì„ íƒ ê³µë¶€</small>
            </div>
            <i class="fas fa-book-open"></i>
        </button>

        <button class="menu-btn" onclick="confirmGameStart()" style="border: 2px solid var(--accent-color);">
            <div>
                <span style="color:var(--accent-color)">ğŸ® ìŠ¤í”¼ë“œ í€´ì¦ˆ</span>
                <small>4ì§€ ì„ ë‹¤í˜• ê²Œì„</small>
            </div>
            <i class="fas fa-gamepad" style="color:var(--accent-color)"></i>
        </button>

        <button class="menu-btn" onclick="showAddScreen()" style="background:#f0f7ff; border:1px dashed #005BAA;">
            <div>
                <span style="color:#005BAA">ğŸ“¥ ë‹¨ì–´ ì¶”ê°€</span>
                <small>ì§ì ‘ ì…ë ¥ or íŒŒì¼ ì—…ë¡œë“œ</small>
            </div>
            <i class="fas fa-plus-circle" style="color:#005BAA"></i>
        </button>
    </div>

    <div id="screen-add" class="screen">
        <h3>ë‹¨ì–´ ì¶”ê°€í•˜ê¸°</h3>
        
        <div class="tab-box">
            <button class="tab-btn active" onclick="switchTab('manual')">ì§ì ‘ ì…ë ¥</button>
            <button class="tab-btn" onclick="switchTab('file')">íŒŒì¼(CSV)</button>
        </div>

        <div id="form-manual" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div class="input-group">
                <label class="input-label">ì±•í„°(í´ë”) ì„ íƒ</label>
                <select id="chap-select" class="input-field" onchange="checkNewChap(this)">
                    </select>
                <input type="text" id="chap-new-input" class="input-field" style="display:none; margin-top:5px;" placeholder="ìƒˆ í´ë” ì´ë¦„ ì…ë ¥">
            </div>
            <div class="input-group">
                <label class="input-label">í˜ë¥´ì‹œì•„ì–´ (Script)</label>
                <input type="text" id="input-word" class="input-field" placeholder="ì˜ˆ: Ø³Ù„Ø§Ù…">
            </div>
            <div class="input-group">
                <label class="input-label">ë°œìŒ (Pronunciation)</label>
                <input type="text" id="input-pron" class="input-field" placeholder="ì˜ˆ: Salam">
            </div>
            <div class="input-group">
                <label class="input-label">í•œêµ­ì–´ ëœ»</label>
                <input type="text" id="input-mean" class="input-field" placeholder="ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”">
            </div>
            <button class="action-btn btn-blue" onclick="addManual()">ì¶”ê°€í•˜ê¸°</button>
        </div>

        <div id="form-file" style="width:100%; display:none; flex-direction:column; align-items:center;">
            <div class="file-upload-wrapper" onclick="document.getElementById('file-input').click()">
                <i class="fas fa-file-upload" style="font-size:2rem; color:#005BAA;"></i>
                <p style="margin:10px 0 0; color:#666;">í„°ì¹˜í•´ì„œ íŒŒì¼(CSV) ì„ íƒ</p>
                <small style="color:#999; display:block; margin-top:5px;">í˜•ì‹: í˜ë¥´ì‹œì•„ì–´,ë°œìŒ,ëœ»,ì±•í„°(ì„ íƒ)</small>
            </div>
            <input type="file" id="file-input" style="display:none;" accept=".csv, .txt" onchange="handleFileUpload(this)">
            
            <div id="file-result" style="margin-bottom:20px; color:#005BAA; font-weight:bold;"></div>
            <button class="action-btn btn-blue" onclick="processFile()">ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div id="screen-chapter" class="screen">
        <h3 id="chapter-title">ë²”ìœ„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
        <div id="chapter-list" style="width: 100%; max-width: 300px;"></div>
    </div>

    <div id="screen-study" class="screen">
        <div id="study-area" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <div class="card-container" onclick="flipCard()">
                <div class="card-inner" id="card-inner">
                    <div class="card-face card-front">
                        <div class="chapter-badge" id="card-chapter">Ch.1</div>
                        <div style="font-size: 0.8rem; color: #aaa; margin-bottom: 20px;">Touch to Flip ğŸ‘†</div>
                        <div class="persian-text" id="word-display">Ready</div>
                    </div>
                    <div class="card-face card-back">
                        <div class="pronun-text" id="pron-display">[Pronunciation]</div>
                        <div class="korean-text" id="mean-display">ì‹œì‘</div>
                    </div>
                </div>
            </div>
            <div class="control-box">
                <button id="btn-memorize" class="btn-check" onclick="toggleMemorize(event)">
                    <i class="far fa-check-circle"></i> ì™¸ì› ì–´ìš”
                </button>
                <button class="btn-next" onclick="nextWord()">ë‹¤ìŒ ğŸ‘‰</button>
            </div>
        </div>
        <div id="study-clear-msg" style="text-align:center; display:none;">
            <i class="fas fa-medal" style="font-size:4rem; color:var(--success-color);"></i>
            <h2>í•™ìŠµ ì™„ë£Œ!</h2>
            <p>ì„ íƒí•œ ë²”ìœ„ì˜ ë‹¨ì–´ë¥¼ ëª¨ë‘ ë´¤ìŠµë‹ˆë‹¤.</p>
            <button class="action-btn btn-blue" onclick="goHome()" style="width:200px; margin-top:20px;">í™ˆìœ¼ë¡œ</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-progress">
            <span id="game-score-badge">ğŸ† 0ì </span>
            <span id="game-q-count">Q. 1 / 10</span>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; width:100%;">
            <div class="quiz-word" id="quiz-word">Salam</div>
            <button onclick="showHint()" style="border:none; background:none; color:#888; margin-bottom:20px; cursor:pointer;">
                <i class="fas fa-eye"></i> ë°œìŒ íŒíŠ¸ ë³´ê¸°
            </button>
            <div id="quiz-pron-hint" style="color:var(--accent-color); margin-bottom:20px; font-weight:bold; display:none;"></div>
            
            <div class="options-grid" id="options-container"></div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div style="text-align:center;">
            <h2 style="margin:0;">Game Over</h2>
            <div style="font-size:4rem; font-weight:bold; color:var(--accent-color); margin:10px 0;" id="final-score">0</div>
            <p>ì´ 10ë¬¸ì œ ì¤‘ <span id="final-correct-cnt">0</span>ê°œ ì •ë‹µ</p>
            <div style="margin-top:30px; display:flex; flex-direction:column; gap:10px;">
                <button class="action-btn btn-orange" onclick="confirmGameStart()">ë‹¤ì‹œ í•˜ê¸°</button>
                <button class="action-btn" onclick="goHome()" style="background:#ddd;">í™ˆìœ¼ë¡œ</button>
            </div>
        </div>
    </div>

    <div id="game-option-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>ê²Œì„ ì˜µì…˜ ì„ íƒ</h3>
            <p>ì–´ë–¤ ë‹¨ì–´ë¡œ ê²Œì„ì„ í• ê¹Œìš”?</p>
            <button class="action-btn btn-blue" onclick="selectGameOption(false)">ğŸ”„ ë³µìŠµ ëª¨ë“œ <br><small style="font-weight:normal; font-size:0.8rem;">(ëª¨ë“  ë‹¨ì–´ ì¶œì œ)</small></button>
            <button class="action-btn btn-orange" onclick="selectGameOption(true)">ğŸ”¥ í•˜ë“œì½”ì–´ ëª¨ë“œ <br><small style="font-weight:normal; font-size:0.8rem;">(ì•ˆ ì™¸ìš´ ê²ƒë§Œ ì¶œì œ)</small></button>
            <button class="action-btn" style="background:white; color:#999; margin-top:10px;" onclick="document.getElementById('game-option-modal').style.display='none'">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="setting-modal" class="modal-overlay" onclick="closeSetting(event)">
        <div class="modal-box">
            <h3>ì„¤ì •</h3>
            <button class="action-btn" style="background:#005BAA; color:white; margin-bottom:10px;" onclick="exportCSV()">ğŸ’¾ ë‚´ ë‹¨ì–´ì¥ ë‹¤ìš´ë¡œë“œ (ë°±ì—…)</button>
            <button class="action-btn" style="background:#ff9f43; color:white; margin-bottom:10px;" onclick="resetCustomData()">ğŸ—‘ï¸ ë‚´ ë‹¨ì–´ì¥ ë¹„ìš°ê¸°</button>
            <button class="action-btn" style="background:#ff6b6b; color:white; margin-bottom:10px;" onclick="resetData()">â†º ì•”ê¸° ê¸°ë¡ ì´ˆê¸°í™”</button>
            <button class="action-btn" style="background:#eee;" onclick="document.getElementById('setting-modal').style.display='none'">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // ==========================================
        // [0] ì´ˆê¸° ë°ì´í„° (Static DB) - ë°°í¬ ì „ ìˆ˜ì • í•„ìˆ˜!
        // ==========================================
        const staticDB = [
            { id: 1, ch: "1ê³¼", w: "Ø³Ù„Ø§Ù…", p: "Salam", m: "ì•ˆë…•í•˜ì„¸ìš”" },
            { id: 2, ch: "1ê³¼", w: "Ø¨ÙØ±Ù…Ø§ÛŒÛŒØ¯", p: "Befarmaid", m: "ì—¬ê¸°ìš” / ë“¤ì–´ì˜¤ì„¸ìš”" },
            { id: 3, ch: "1ê³¼", w: "Ø®Ø¯Ø§Ø­Ø§ÙØ¸", p: "Khoda hafez", m: "ì•ˆë…•íˆ ê°€ì„¸ìš”" },
            { id: 4, ch: "1ê³¼", w: "Ù…Ø±Ø³ÛŒ", p: "Merci", m: "ê³ ë§™ìŠµë‹ˆë‹¤" },
            { id: 5, ch: "2ê³¼", w: "Ø³ÙÛŒØ¯", p: "Sefid", m: "í°ìƒ‰" },
            { id: 6, ch: "2ê³¼", w: "Ø³ÛŒØ§Ù‡", p: "Siah", m: "ê²€ì€ìƒ‰" },
            { id: 7, ch: "2ê³¼", w: "Ù‚Ø±Ù…Ø²", p: "Ghermez", m: "ë¹¨ê°„ìƒ‰" },
            { id: 8, ch: "2ê³¼", w: "Ø¢Ø¨ÛŒ", p: "Abi", m: "íŒŒë€ìƒ‰" },
            { id: 9, ch: "3ê³¼", w: "Ø§Ø±Ø²Ø§Ù†", p: "Arzan", m: "ì €ë ´í•œ" },
            { id: 10, ch: "3ê³¼", w: "Ú¯Ø±Ø§Ù†", p: "Geran", m: "ë¹„ì‹¼" },
            { id: 11, ch: "3ê³¼", w: "Ø®ÙˆØ¨", p: "Khob", m: "ì¢‹ì€" },
            { id: 12, ch: "3ê³¼", w: "Ø¨Ø¯", p: "Bad", m: "ë‚˜ìœ" }
        ];

        // ==========================================
        // [1] ë°ì´í„° ê´€ë¦¬
        // ==========================================
        const MEMO_KEY = 'hufs_persian_memo';
        const CUSTOM_KEY = 'hufs_persian_custom_db';

        let memorizedList = JSON.parse(localStorage.getItem(MEMO_KEY)) || [];
        let customDB = JSON.parse(localStorage.getItem(CUSTOM_KEY)) || [];

        function getAllWords() { return [...staticDB, ...customDB]; }

        function getChapters() {
            const allWords = getAllWords();
            const chapters = [...new Set(allWords.map(item => item.ch))];
            return chapters.sort((a,b) => a.toString().localeCompare(b.toString()));
        }

        // ==========================================
        // [2] ë‹¨ì–´ ì¶”ê°€ (3ë‹¨ ë°ì´í„°: W, P, M)
        // ==========================================
        function showAddScreen() {
            showScreen('screen-add');
            updateChapSelectOptions();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(tabName==='manual') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('form-manual').style.display = 'flex';
                document.getElementById('form-file').style.display = 'none';
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('form-manual').style.display = 'none';
                document.getElementById('form-file').style.display = 'flex';
            }
        }

        function updateChapSelectOptions() {
            const select = document.getElementById('chap-select');
            select.innerHTML = '';
            
            const chapters = getChapters();
            chapters.forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch;
                opt.innerText = ch;
                select.appendChild(opt);
            });
            const newOpt = document.createElement('option');
            newOpt.value = 'NEW_FOLDER_OPTION';
            newOpt.innerText = '+ ìƒˆ í´ë” ë§Œë“¤ê¸°';
            select.appendChild(newOpt);
            
            document.getElementById('chap-new-input').style.display = 'none';
        }

        function checkNewChap(select) {
            const input = document.getElementById('chap-new-input');
            if(select.value === 'NEW_FOLDER_OPTION') {
                input.style.display = 'block';
                input.focus();
            } else {
                input.style.display = 'none';
            }
        }

        function addManual() {
            const w = document.getElementById('input-word').value.trim();
            const p = document.getElementById('input-pron').value.trim();
            const m = document.getElementById('input-mean').value.trim();
            const selectVal = document.getElementById('chap-select').value;
            let ch = selectVal;

            if(selectVal === 'NEW_FOLDER_OPTION') {
                ch = document.getElementById('chap-new-input').value.trim();
                if(!ch) { alert("í´ë” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            }

            if(!w || !m) { alert('ë‹¨ì–´ì™€ ëœ»ì€ í•„ìˆ˜ì…ë‹ˆë‹¤!'); return; }

            customDB.push({ id: Date.now(), ch: ch, w: w, p: p, m: m });
            localStorage.setItem(CUSTOM_KEY, JSON.stringify(customDB));
            
            alert(`[${ch}]ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            document.getElementById('input-word').value = '';
            document.getElementById('input-pron').value = '';
            document.getElementById('input-mean').value = '';
            updateChapSelectOptions();
        }

        // CSV ì—…ë¡œë“œ ì²˜ë¦¬
        let pendingFileText = null;
        function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                pendingFileText = e.target.result;
                document.getElementById('file-result').innerText = `ğŸ“„ ${file.name} (ì¤€ë¹„ì™„ë£Œ)`;
            };
            reader.readAsText(file, 'UTF-8');
        }

        function processFile() {
            if(!pendingFileText) { alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

            const lines = pendingFileText.split('\n');
            let count = 0;
            
            lines.forEach((line, idx) => {
                const parts = line.split(',');
                // CSV í˜•ì‹: ë‹¨ì–´,ë°œìŒ,ëœ»,[ì±•í„°]
                if(parts.length >= 3) {
                    const w = parts[0].trim();
                    const p = parts[1].trim();
                    const m = parts[2].trim();
                    const ch = (parts[3] && parts[3].trim()) ? parts[3].trim() : "ë‚´ ë‹¨ì–´ì¥";
                    
                    if(w && m) {
                        customDB.push({ id: Date.now() + idx, ch: ch, w: w, p: p, m: m });
                        count++;
                    }
                }
            });

            if(count > 0) {
                localStorage.setItem(CUSTOM_KEY, JSON.stringify(customDB));
                alert(`${count}ê°œ ë‹¨ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                document.getElementById('file-input').value = '';
                document.getElementById('file-result').innerText = '';
                pendingFileText = null;
                goHome();
            } else {
                alert("í˜•ì‹ ì˜¤ë¥˜: [í˜ë¥´ì‹œì•„ì–´,ë°œìŒ,ëœ»] ìˆœì„œê°€ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        // ==========================================
        // [3] ê²Œì„ ëª¨ë“œ
        // ==========================================
        let gameExcludeMemorized = false;

        function confirmGameStart() {
            document.getElementById('game-option-modal').style.display = 'flex';
        }

        function selectGameOption(isHardcore) {
            gameExcludeMemorized = isHardcore;
            document.getElementById('game-option-modal').style.display = 'none';
            showChapterSelect('game');
        }

        // ==========================================
        // [4] í•™ìŠµ/ê²Œì„ ë¡œì§
        // ==========================================
        let currentMode = '';
        let targetChapter = 'all';
        let studyQueue = [];
        let currentStudyWord = null;
        let gameQueue = [];
        let gameScore = 0;
        let gameCount = 0;
        let gameTotalQ = 10;
        let isAnswerChecking = false;

        function showChapterSelect(mode) {
            currentMode = mode;
            const listContainer = document.getElementById('chapter-list');
            listContainer.innerHTML = "";
            document.getElementById('chapter-title').innerText = (mode === 'game') ? "ê²Œì„ ë²”ìœ„ ì„ íƒ" : "í•™ìŠµ ë²”ìœ„ ì„ íƒ";

            const fullDB = getAllWords();
            const chapters = getChapters();

            if(mode === 'game') {
                const allBtn = document.createElement('button');
                allBtn.className = 'menu-btn';
                allBtn.innerHTML = `<div><span>ğŸ² ì „ì²´ ë²”ìœ„</span></div><i class="fas fa-chevron-right"></i>`;
                allBtn.onclick = () => setModeAndGo(mode, 'all');
                listContainer.appendChild(allBtn);
            }

            chapters.forEach(ch => {
                const total = fullDB.filter(i => i.ch === ch).length;
                const done = fullDB.filter(i => i.ch === ch && memorizedList.includes(i.id)).length;
                
                const btn = document.createElement('button');
                btn.className = 'menu-btn';
                btn.innerHTML = `
                    <div style="text-align:left;">
                        <span>ğŸ“– ${ch}</span>
                        ${mode === 'study' ? `<small style="color:${done===total?'#2ecc71':'#888'}">ì§„ë„ìœ¨: ${done}/${total}</small>` : ''}
                    </div>
                    <i class="fas fa-chevron-right"></i>
                `;
                btn.onclick = () => setModeAndGo(mode, ch);
                listContainer.appendChild(btn);
            });
            showScreen('screen-chapter');
        }

        function setModeAndGo(mode, chapter) {
            targetChapter = chapter;
            if (mode === 'study') startStudy();
            else startGame();
        }

        function startStudy() {
            const fullDB = getAllWords();
            let list = (targetChapter === 'all') ? fullDB : fullDB.filter(i => i.ch === targetChapter);
            studyQueue = list.filter(item => !memorizedList.includes(item.id));
            
            document.getElementById('study-area').style.display = 'flex';
            document.getElementById('study-clear-msg').style.display = 'none';

            if (studyQueue.length === 0) {
                showScreen('screen-study');
                document.getElementById('study-area').style.display = 'none';
                document.getElementById('study-clear-msg').style.display = 'block';
            } else {
                studyQueue.sort(() => Math.random() - 0.5);
                showScreen('screen-study');
                nextWord();
            }
        }

        function nextWord() {
            const card = document.querySelector('.card-container');
            if (card.classList.contains('flipped')) card.classList.remove('flipped');
            setTimeout(() => {
                if (studyQueue.length === 0) {
                    document.getElementById('study-area').style.display = 'none';
                    document.getElementById('study-clear-msg').style.display = 'block';
                    return;
                }
                const randIdx = Math.floor(Math.random() * studyQueue.length);
                currentStudyWord = studyQueue[randIdx];
                
                document.getElementById('card-chapter').innerText = currentStudyWord.ch;
                document.getElementById('word-display').innerText = currentStudyWord.w; // í˜ë¥´ì‹œì•„ì–´
                document.getElementById('pron-display').innerText = `[${currentStudyWord.p || ''}]`; // ë°œìŒ
                document.getElementById('mean-display').innerText = currentStudyWord.m; // ëœ»
                updateCheckButton(false);
            }, 300);
        }

        function toggleMemorize(e) {
            e.stopPropagation();
            if (!currentStudyWord) return;
            memorizedList.push(currentStudyWord.id);
            localStorage.setItem(MEMO_KEY, JSON.stringify(memorizedList));
            updateCheckButton(true);
            studyQueue = studyQueue.filter(i => i.id !== currentStudyWord.id);
            setTimeout(nextWord, 500);
        }

        function updateCheckButton(isChecked) {
            const btn = document.getElementById('btn-memorize');
            if (isChecked) {
                btn.classList.add('checked');
                btn.innerHTML = `<i class="fas fa-check-circle"></i> ì•”ê¸° ì™„ë£Œ!`;
            } else {
                btn.classList.remove('checked');
                btn.innerHTML = `<i class="far fa-check-circle"></i> ì™¸ì› ì–´ìš”`;
            }
        }

        function startGame() {
            const fullDB = getAllWords();
            let list = (targetChapter === 'all') ? fullDB : fullDB.filter(i => i.ch === targetChapter);

            if (gameExcludeMemorized) {
                list = list.filter(item => !memorizedList.includes(item.id));
            }

            if (list.length < 4) {
                alert("ê²Œì„ í•  ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! (ìµœì†Œ 4ê°œ í•„ìš”)");
                return;
            }

            gameQueue = [...list].sort(() => Math.random() - 0.5);
            gameScore = 0;
            gameCount = 0;
            gameTotalQ = Math.min(10, list.length);

            showScreen('screen-game');
            nextQuestion();
        }

        function nextQuestion() {
            if (gameCount >= gameTotalQ) { endGame(); return; }
            gameCount++;
            document.getElementById('game-score-badge').innerText = `ğŸ† ${gameScore * 10}ì `;
            document.getElementById('game-q-count').innerText = `Q. ${gameCount} / ${gameTotalQ}`;
            document.getElementById('options-container').innerHTML = '';
            document.getElementById('quiz-pron-hint').style.display = 'none'; // íŒíŠ¸ ìˆ¨ê¹€

            if (gameQueue.length === 0) {
                 const fullDB = getAllWords();
                 let list = (targetChapter === 'all') ? fullDB : fullDB.filter(i => i.ch === targetChapter);
                 if (gameExcludeMemorized) list = list.filter(item => !memorizedList.includes(item.id));
                 gameQueue = [...list].sort(() => Math.random() - 0.5);
            }
            const answer = gameQueue.pop();

            // íŒíŠ¸ ì„¸íŒ…
            document.getElementById('quiz-pron-hint').innerText = answer.p;

            // ë³´ê¸° ìƒì„±
            let options = [answer];
            const fullDB = getAllWords();
            let wrongCandidates = fullDB.filter(i => i.id !== answer.id);
            wrongCandidates.sort(() => Math.random() - 0.5);
            options.push(...wrongCandidates.slice(0, 3));
            options.sort(() => Math.random() - 0.5);

            document.getElementById('quiz-word').innerText = answer.w;
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt.m;
                btn.onclick = () => checkAnswer(btn, opt.id, answer.id);
                document.getElementById('options-container').appendChild(btn);
            });
        }

        function showHint() {
            document.getElementById('quiz-pron-hint').style.display = 'block';
        }

        function checkAnswer(btn, selectedId, correctId) {
            if (isAnswerChecking) return;
            isAnswerChecking = true;
            if (selectedId === correctId) {
                btn.classList.add('correct');
                gameScore++;
            } else {
                btn.classList.add('wrong');
            }
            setTimeout(() => {
                isAnswerChecking = false;
                nextQuestion();
            }, 800);
        }

        function endGame() {
            showScreen('screen-result');
            document.getElementById('final-score').innerText = gameScore * 10;
            document.getElementById('final-correct-cnt').innerText = gameScore;
        }

        // ==========================================
        // [5] ì„¤ì • ë° ë°ì´í„° ë‚´ë³´ë‚´ê¸° (Export)
        // ==========================================
        function exportCSV() {
            if (customDB.length === 0) {
                alert("ë‹¤ìš´ë¡œë“œí•  ë‚´ ë‹¨ì–´ì¥ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
                return;
            }
            // CSV ë‚´ìš© ìƒì„± (í˜•ì‹: ë‹¨ì–´,ë°œìŒ,ëœ»,ì±•í„°)
            let csvContent = "\uFEFF"; 
            customDB.forEach(item => {
                csvContent += `${item.w},${item.p},${item.m},${item.ch}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            const date = new Date();
            const dateStr = date.getFullYear() + "-" + (date.getMonth()+1) + "-" + date.getDate();
            
            link.setAttribute("href", url);
            link.setAttribute("download", `My_Persian_Words_${dateStr}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function flipCard() { document.querySelector('.card-container').classList.toggle('flipped'); }
        function updateProgressInfo() {
            const fullDB = getAllWords();
            const total = fullDB.length;
            const done = memorizedList.length;
            const percent = total > 0 ? Math.round((done / total) * 100) : 0;
            document.getElementById('progress-info').innerText = `ì´ ì•”ê¸°ìœ¨: ${percent}% (${done}/${total})`;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            const homeBtn = document.querySelector('.home-btn');
            const settingBtn = document.querySelector('.right-btn');
            const title = document.getElementById('header-title');
            
            if (screenId === 'screen-home') {
                homeBtn.style.display = 'none';
                settingBtn.style.display = 'block';
                title.innerText = "HUFS Persian";
                updateProgressInfo();
            } else if (screenId === 'screen-add') {
                homeBtn.style.display = 'block';
                settingBtn.style.display = 'none';
                title.innerText = "ë‹¨ì–´ ì¶”ê°€";
            } else {
                homeBtn.style.display = 'block';
                settingBtn.style.display = 'none';
                title.innerText = (screenId.includes('game')) ? "Speed Quiz" : "í•™ìŠµ ëª¨ë“œ";
            }
        }
        function goHome() { showScreen('screen-home'); }
        function toggleSetting() { document.getElementById('setting-modal').style.display = 'flex'; }
        function closeSetting(e) { if (e.target.id === 'setting-modal') document.getElementById('setting-modal').style.display = 'none'; }
        
        function resetCustomData() {
            if(confirm("ë‚´ê°€ ì¶”ê°€í•œ ë‹¨ì–´ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                customDB = [];
                localStorage.removeItem(CUSTOM_KEY);
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('setting-modal').style.display = 'none';
                goHome();
            }
        }
        function resetData() {
            if(confirm("ì•”ê¸° ì²´í¬ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                memorizedList = [];
                localStorage.setItem(MEMO_KEY, JSON.stringify(memorizedList));
                alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('setting-modal').style.display = 'none';
                goHome();
            }
        }
        
        // ì´ˆê¸° ì‹¤í–‰
        updateProgressInfo();
    </script>
</body>
</html>
